<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Staking | Crypto.com Chain</title>
    <meta name="description" content="Welcome to Crypto.com Chain&#39;s documentation!">
    
    
    <link rel="preload" href="/demo-doc-2/assets/css/0.styles.e1dd3de1.css" as="style"><link rel="preload" href="/demo-doc-2/assets/js/app.a0a1c90b.js" as="script"><link rel="preload" href="/demo-doc-2/assets/js/2.f731f746.js" as="script"><link rel="preload" href="/demo-doc-2/assets/js/16.2d6c9435.js" as="script"><link rel="prefetch" href="/demo-doc-2/assets/js/10.64fdd20c.js"><link rel="prefetch" href="/demo-doc-2/assets/js/11.b2d8a5fd.js"><link rel="prefetch" href="/demo-doc-2/assets/js/12.2e0e00bd.js"><link rel="prefetch" href="/demo-doc-2/assets/js/13.b5099882.js"><link rel="prefetch" href="/demo-doc-2/assets/js/14.26daa238.js"><link rel="prefetch" href="/demo-doc-2/assets/js/15.b983d492.js"><link rel="prefetch" href="/demo-doc-2/assets/js/17.a117b0b7.js"><link rel="prefetch" href="/demo-doc-2/assets/js/18.f2e419c2.js"><link rel="prefetch" href="/demo-doc-2/assets/js/19.8d017d75.js"><link rel="prefetch" href="/demo-doc-2/assets/js/20.834fbdab.js"><link rel="prefetch" href="/demo-doc-2/assets/js/3.dd5706d6.js"><link rel="prefetch" href="/demo-doc-2/assets/js/4.a322b794.js"><link rel="prefetch" href="/demo-doc-2/assets/js/5.509d06a8.js"><link rel="prefetch" href="/demo-doc-2/assets/js/6.1f79c5a5.js"><link rel="prefetch" href="/demo-doc-2/assets/js/7.62eacd4b.js"><link rel="prefetch" href="/demo-doc-2/assets/js/8.c8aafa90.js"><link rel="prefetch" href="/demo-doc-2/assets/js/9.ac8ae905.js">
    <link rel="stylesheet" href="/demo-doc-2/assets/css/0.styles.e1dd3de1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/demo-doc-2/" class="home-link router-link-active"><!----> <span class="site-name">Crypto.com Chain</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/demo-doc-2/" class="nav-link">Home</a></div><div class="nav-item"><a href="/demo-doc-2/getting-started/" class="nav-link router-link-active">Getting Started</a></div><div class="nav-item"><a href="https://github.com/crypto-com/chain/tree/master/client-rpc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Client RPC
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://brianmco.github.io/demo-doc-2/Crypto.com_Chain.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Download
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/demo-doc-2/" class="nav-link">Home</a></div><div class="nav-item"><a href="/demo-doc-2/getting-started/" class="nav-link router-link-active">Getting Started</a></div><div class="nav-item"><a href="https://github.com/crypto-com/chain/tree/master/client-rpc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Client RPC
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://brianmco.github.io/demo-doc-2/Crypto.com_Chain.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Download
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/demo-doc-2/getting-started/" class="sidebar-link">Getting Started</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#pre-requisites" class="sidebar-link">Pre-requisites</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#how-it-works" class="sidebar-link">How it works</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#compile-enclave" class="sidebar-link">Compile enclave</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#setup-path" class="sidebar-link">Setup path</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#install-rust" class="sidebar-link">Install Rust</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#install-tendermint" class="sidebar-link">Install Tendermint</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#get-source-code" class="sidebar-link">Get source code</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#compile-chain-abci" class="sidebar-link">Compile chain-abci</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#run-the-program" class="sidebar-link">Run the program</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/#other-information" class="sidebar-link">Other information</a></li></ul></li><li><a href="/demo-doc-2/getting-started/consensus.html" class="sidebar-link">Consensus</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/consensus.html#client-interacting-with-the-blockchain" class="sidebar-link">Client: Interacting with the blockchain</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/consensus.html#app-hash" class="sidebar-link">APP HASH</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/consensus.html#conventions" class="sidebar-link">Conventions</a></li></ul></li><li><a href="/demo-doc-2/getting-started/genesis.html" class="sidebar-link">Genesis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/genesis.html#tendermint-extra-information" class="sidebar-link">Tendermint extra information</a></li></ul></li><li><a href="/demo-doc-2/getting-started/transaction-accounting-model.html" class="sidebar-link">Transaction Accounting Model</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction-accounting-model.html#motivation" class="sidebar-link">Motivation</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction-accounting-model.html#utxo-accounts-model" class="sidebar-link">UTXO+Accounts model</a></li></ul></li><li><a href="/demo-doc-2/getting-started/transaction.html" class="sidebar-link">Transaction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction.html#transaction-identifier" class="sidebar-link">Transaction Identifier</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction.html#witness" class="sidebar-link">Witness</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction.html#textual-address-representation" class="sidebar-link">Textual Address Representation</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction.html#transaction-fees" class="sidebar-link">Transaction Fees</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction.html#transaction-types" class="sidebar-link">Transaction Types</a></li></ul></li><li><a href="/demo-doc-2/getting-started/serialization.html" class="sidebar-link">Serialization</a></li><li><a href="/demo-doc-2/getting-started/signature-schemes.html" class="sidebar-link">Signature Schemes</a></li><li><a href="/demo-doc-2/getting-started/client-flow.html" class="sidebar-link">Client Flow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/client-flow.html#block-level-filtering" class="sidebar-link">Block-level filtering</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/client-flow.html#client-knows-transaction" class="sidebar-link">Client knows transaction</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/client-flow.html#client-doesn’t-know-transaction-data" class="sidebar-link">Client doesn’t know transaction data</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/client-flow.html#payment-transaction-submission" class="sidebar-link">Payment transaction submission</a></li></ul></li><li><a href="/demo-doc-2/getting-started/enclave-architecture.html" class="sidebar-link">Enclave Architecture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/enclave-architecture.html#technology" class="sidebar-link">Technology</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/enclave-architecture.html#transaction-validation" class="sidebar-link">Transaction validation</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/enclave-architecture.html#transaction-data-bootstrapping" class="sidebar-link">Transaction data bootstrapping</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/enclave-architecture.html#transaction-querying" class="sidebar-link">Transaction querying</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/enclave-architecture.html#transaction-creation" class="sidebar-link">Transaction creation</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/enclave-architecture.html#enclave-breaches" class="sidebar-link">Enclave breaches</a></li></ul></li><li><a href="/demo-doc-2/getting-started/transaction-privacy.html" class="sidebar-link">Transaction Privacy</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction-privacy.html#motivation" class="sidebar-link">Motivation</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction-privacy.html#payloads" class="sidebar-link">Payloads</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/transaction-privacy.html#periodic-key-generation" class="sidebar-link">Periodic key generation</a></li></ul></li><li><a href="/demo-doc-2/getting-started/staking.html" class="active sidebar-link">Staking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#account" class="sidebar-link">Account</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#council-node" class="sidebar-link">Council Node</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#service-node" class="sidebar-link">Service Node</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#transaction-fee" class="sidebar-link">Transaction Fee</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#rewards" class="sidebar-link">Rewards</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#slashing" class="sidebar-link">Slashing</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/staking.html#“global-state”-app-hash" class="sidebar-link">“Global state” / APP_HASH</a></li></ul></li><li><a href="/demo-doc-2/getting-started/notes-on-production-deployment.html" class="sidebar-link">Notes on Production Deployment</a></li><li><a href="/demo-doc-2/getting-started/notes-on-performance.html" class="sidebar-link">Notes on Performance</a></li><li><a href="/demo-doc-2/getting-started/threat-model.html" class="sidebar-link">Threat Model</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/threat-model.html#severity" class="sidebar-link">Severity</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/threat-model.html#exploitability" class="sidebar-link">Exploitability</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/threat-model.html#assets" class="sidebar-link">Assets</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/threat-model.html#scope" class="sidebar-link">Scope</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/threat-model.html#system-diagram" class="sidebar-link">System Diagram</a></li><li class="sidebar-sub-header"><a href="/demo-doc-2/getting-started/threat-model.html#result" class="sidebar-link">Result</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="staking"><a href="#staking" aria-hidden="true" class="header-anchor">#</a> Staking</h1> <p>This doc cointains the specification of the initial staking, slashing, fees and rewards mechanisms.</p> <h2 id="account"><a href="#account" aria-hidden="true" class="header-anchor">#</a> Account</h2> <p>Account is a data structure that holds state about staking:</p> <div class="language- extra-class"><pre class="language-text"><code>pub struct Account {
    pub nonce: usize, // transaction counter
    pub bonded: Coin, // bonded staked amount
    pub unbonded: Coin, // unbonded staked amount
    pub unbonded_from: Timespec, // when the unboded staked amount can be withdrawn
    pub address: RedeemAddress, // ETH-style address; TODO: extended address?
    pub jailed_until: Option&lt;Timespec&gt;, // has the account been jailed in slashing-related logic?
    pub slashed: Option&lt;SlashingPeriod&gt;, // how much is the account supposed to be slashed in slashing-related logic?
}
</code></pre></div><p>TODO: should it have a minimum bonded amount?</p> <h2 id="council-node"><a href="#council-node" aria-hidden="true" class="header-anchor">#</a> Council Node</h2> <p>Council Node is a data structure that holds state about a node responsible for transaction validation and service node whitelist management:</p> <div class="language- extra-class"><pre class="language-text"><code>pub struct CouncilNode {
    pub staking_address: RedeemAddress, // account with the required staked amount
    pub consensus_pubkey: crypto.PubKey, // Tendermint consensus validator-associated public key: note that Tendermint supports different signature schemes
    pub council_pubkey: PublicKey, // key for council node-related transaction types
    pub service_whitelist_pubkey: PublicKey, // key for service node whitelist-related transaction types
    pub nonce: usize, // update counter
}
</code></pre></div><h2 id="service-node"><a href="#service-node" aria-hidden="true" class="header-anchor">#</a> Service Node</h2> <p>Service Node is a data structure that holds state about a high responsibility node and its offered service:</p> <div class="language- extra-class"><pre class="language-text"><code>pub struct ServiceNode {
    pub staking_address: RedeemAddress, // account with the required staked amount
    pub service_pubkey: PublicKey, // key for service node whitelist entry updates
    pub service_type: ServiceNodeType, // what service this node offers
    pub service_url: URL, // HTTPS endpoint of the provided service
    pub nonce: usize, // update counter
}
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>pub enum ServiceNodeType {
    CustomerAcquirer, // (optional) custodial multi-currency wallet provider
    MerchantAcquirer, // (optional) verified merchant ID management provider, payment gateway, merchant custodial currency risk management and per-agreement fiat settlements (most initial on-boarded merchants will most likely prefer to avoid volatility risks)
    SettlementAgent, // provides currency exchange service (e.g. via IBC and DEX)
}
</code></pre></div><p>As most of the functionality is meant to faciliate some actions outside Chain, the information is recorded in the flexible form of storing a URL pointing to HTTPS API. These API endpoints will either directly execute some action or return information required for the action to be executed (e.g. other protocol’s details).</p> <h2 id="transaction-fee"><a href="#transaction-fee" aria-hidden="true" class="header-anchor">#</a> Transaction Fee</h2> <p>The minimal transaction fee is defined according to the formula:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;BASE_AMOUNT&gt; + &lt;PER_BYTE&gt; * size
</code></pre></div><p><code>BASE_AMOUNT</code> and <code>PER_BYTE</code> are special network parameters in a fraction of CRO. <code>size</code> is the serialized transaction data’s size in bytes.</p> <p>Basic (<code>TransferTX</code>, <code>DepositStakeTx</code>, <code>WithdrawUnbondedTx</code>, <code>UnbondStakeTx</code>,) transaction types need to check</p> <div class="language- extra-class"><pre class="language-text"><code>sum(inputs amounts) or account.unbonded/bonded == sum(outputs amounts) + fee
</code></pre></div><p>The fee goes to the rewards pool.</p> <p>For Advanced TX types (council node and service node state metadata management), the initial prototype will not require a fee.</p> <h2 id="rewards"><a href="#rewards" aria-hidden="true" class="header-anchor">#</a> Rewards</h2> <p>The rewards pool is a data structure that stores the information about remaining funds:</p> <div class="language- extra-class"><pre class="language-text"><code>pub struct RewardsPool {
    pub nonce: usize, // update counter
    pub total_remaining: Coin, // total available amount
    pub last_update: Timespec, // when was the pool last updated
}
</code></pre></div><p>The initial prototype will have a <code>DAILY_DISTRIBUTION_AMOUNT</code> network parameter; later on, it should be a function that takes a target emission rate, total remaining amount etc. as parameters.</p> <h3 id="distribution"><a href="#distribution" aria-hidden="true" class="header-anchor">#</a> Distribution</h3> <p>Each validator will maintain this structures (perhaps persistent / on-disk): <code>day_claim_council_node: Map&lt;CouncilNode, BlockCount&gt;</code></p> <p>The actual distribution then happens once in a while in BeginBlock, here’s a pseudo code:</p> <div class="language- extra-class"><pre class="language-text"><code>for each validator in BeginBlock.LastCommitInfo:
    lookup validator's staking_address
    if day_claim_council_node[validator_day_claim_council_node] is Nil:
        day_claim_council_node[validator_day_claim_council_node] = 0
    day_claim_council_node[validator_day_claim_council_node] += 1

for each node in day_claim_council_node:
    if node.staking_address.jailed_until.is_some() OR node.staking_address.jailed_until.is_some() OR
    node.slashed.is_some() OR
    node.staking_address.bonded &lt; COUNCIL_NODE_MIN_STAKE:
        remove node from claim set

if BeginBlock.time &gt;= RewardsPool.last_update + 24 hours:
    validator_amount = min(DAILY_DISTRIBUTION_AMOUNT, RewardsPool.total_remaining)

    for each node in day_claim_council_node:
        node_share = compute_share(node, day_claim_council_node, validator_amount)
        END/COMMIT_BLOCK_STATE_UPDATE(node.staking_address.bonded += node_share; node.staking_address.nonce += 1)

    END/COMMIT_BLOCK_STATE_UPDATE(RewardsPool.total_remaining -= amount; RewardsPool.nonce += 1; RewardsPool.last_update = BeginBlock.time)
    day_claim_council_node = {}
</code></pre></div><p><code>compute_share</code> determines the amount for each claiming node; the initial prototype will compute it:</p> <ul><li>council nodes: proportional to the signed block count (node block signatures / all block validators signatures)</li></ul> <div class="tip custom-block"><p class="custom-block-title">NOTE</p> <p>The draft technical whitepaper says there will be rewards for acquirer nodes. These terms may be revised in later drafts.</p></div> <h2 id="slashing"><a href="#slashing" aria-hidden="true" class="header-anchor">#</a> Slashing</h2> <p>This part describes functionality that aims to disincentivize network-observable actions, such as faulty validations, of participants with values at stake by penalizing/slashing them. The penalties may include losing some amount of their stake (surrendered to the rewards pool), losing their ability to perform the network functionality for a period of time, collect rewards etc.</p> <h3 id="slashing-period"><a href="#slashing-period" aria-hidden="true" class="header-anchor">#</a> Slashing period</h3> <p>Some of the faulty behavior may be non-malicious, e.g. due to misconfiguration. In order to mitigate the impact of these initially likely categories of faults, there is a concept of a slashing period whereby the penalty is capped. As penalties are specified in fixed decimal fractions of a stake, it is the highest fraction. In other words, in a given period, a violator is punished for the worst violation rather than losing all stake.</p> <p>Even with this “more tolerant” punishment setup, it will still be quite expensive and desirable to avoid. Note that this setup must be accompanied by immediate jailing / limiting the violater’s network ability.</p> <p>This is a sketched out additional data structure to keep track of (a part of Account):</p> <div class="language- extra-class"><pre class="language-text"><code>pub struct SlashingPeriod {
    pub start: Timespec, // when the period started,
    pub end: Timespec, // when the period ended,
    pub slashed_ratio: Decimal, // fixed decimal; cumulative so far slashed fraction; 0.0 initially
}
</code></pre></div><h3 id="unjail"><a href="#unjail" aria-hidden="true" class="header-anchor">#</a> Unjail</h3> <p>When the previous violator wishes to resume the functionality, the node operator can send a signed <code>UnjailTx</code>. Its validation logic is the following:</p> <div class="language- extra-class"><pre class="language-text"><code>block_time = (... from beginblock ...)
account = (...lookup / recover from signature...)
if account not found:
    return invalid(&quot;account not found&quot;)

if account.jailed_until.is_none():
    return invalid(&quot;account not jailed&quot;)

if nonce != account.nonce + 1:
    return invalid(&quot;invalid nonce&quot;)

if block_time &lt; account.jailed_until.unwrap() || (account.slashed.is_some() &amp;&amp; account.slashed.end &gt; block_time):
    return invalid(&quot;account still jailed&quot;)

if !check_signature(txid):
    return invalid(&quot;invalid signature&quot;)

END/COMMIT_BLOCK_STATE_UPDATE(deduct(account); account.jailed = None)
</code></pre></div><p>TODO: auto-unjailing?</p> <h3 id="tracking"><a href="#tracking" aria-hidden="true" class="header-anchor">#</a> Tracking</h3> <h4 id="validators-council-nodes"><a href="#validators-council-nodes" aria-hidden="true" class="header-anchor">#</a> Validators / Council Nodes</h4> <p>Each BeginBlock contains two fields that will determine penalties:</p> <ul><li>LastCommitInfo: this contains information which validators signed the last block</li> <li>ByzantineValidators: evidence of validators that acted maliciously</li></ul> <p>Their processing is the following:</p> <div class="language- extra-class"><pre class="language-text"><code>for each evidence in ByzantineValidators:
    if evidence.Timestamp &gt;= BeginBlock.Timestamp - MAX_EVIDENCE_AGE:
        account = (... get corresponding account ...)
        if account.slashing_period.end is set and it's before BeginBlock.Timestamp:
            account.slashing_period.slashed_ratio = max(account.slashing_period.slashed_ratio, BYZANTINE_SLASH_RATIO)
        else:
            if account.slashing_period.end is set and it's after BeginBlock.Timestamp:
                END/COMMIT_BLOCK_STATE_UPDATE(deduct(slashing_period, account))

            account.slashing_period = Some(SlashingPeriod(start = Some(BeginBlock.Timestamp),
                end = Some(BeginBlock.Timestamp + SLASHING_PERIOD_DURATION, slashed_ratio = BYZANTINE_SLASH_RATIO)))
            account.jailed_until = Some(BeginBlock.Timestamp + JAIL_DURATION)


for each signer in LastCommitInfo:
    council_node = (... lookup by signer / tendermint validator key ...)
    update(council_node, BLOCK_SIGNING_WINDOW)

for each council_node:
    missed_blocks = get_missed_signed_blocks(council_node)
    if missed_blocks / BLOCK_SIGNING_WINDOW &gt;= MISSED_BLOCK_THRESHOLD:
        account = (... lookup corresponding account ...)
        if account.slashing_period.end is set and it's before BeginBlock.Timestamp:
            account.slashing_period.slashed_ratio = max(account.slashing_period.slashed_ratio, LIVENESS_SLASH_RATIO)
        else:
            if account.slashing_period.end is set and it's after BeginBlock.Timestamp:
                END/COMMIT_BLOCK_STATE_UPDATE(deduct(slashing_period, account))

            account.slashing_period = Some(SlashingPeriod(start = Some(BeginBlock.Timestamp),
                end = Some(BeginBlock.Timestamp + SLASHING_PERIOD_DURATION, slashed_ratio = LIVENESS_SLASH_RATIO)))
            account.jailed_until = Some(BeginBlock.Timestamp + JAIL_DURATION)
</code></pre></div><h2 id="“global-state”-app-hash"><a href="#“global-state”-app-hash" aria-hidden="true" class="header-anchor">#</a> “Global state” / APP_HASH</h2> <p>Tendermint expects a single compact value, <code>APP_HASH</code>, after each BlockCommit that represents the state of the application. In the early Chain prototype, this was constructed as a root of a Merkle tree from IDs of valid transactions.</p> <p>In this staking scenario, some form of “chimeric ledger” needs to be employed, as staking-related functionality is represented with accounts. In Eth, Merkle Patricia Trees are used: https://github.com/ethereum/wiki/wiki/Design-Rationale#merkle-patricia-trees (The alternative in TM: https://github.com/tendermint/iavl depends on the order of transactions though)</p> <p>They could possibly be used to represent an UTXO set: https://medium.com/codechain/codechains-merkleized-utxo-set-c76c9376fd4f</p> <p>The overall “global state” then consists of the following items:</p> <ul><li>UTXO set</li> <li>Account</li> <li>RewardsPool</li> <li>CouncilNode</li> <li>ServiceNode</li> <li>MerchantWhitelist (not yet spec-out / TODO)</li></ul> <p>So each component could possibly be represented as MPT and these MPTs would then be combined together to form a single <code>APP_HASH</code>.</p> <h3 id="network-parameters"><a href="#network-parameters" aria-hidden="true" class="header-anchor">#</a> Network Parameters</h3> <p>This section aims to collect all the mentioned network parameters:</p> <ul><li><code>BASE_AMOUNT</code></li> <li><code>PER_BYTE</code></li> <li><code>COMMUNITY_NODE_MIN_STAKE</code></li> <li><code>DAILY_DISTRIBUTION_AMOUNT</code></li> <li><code>PER_MERCHANT_MIN_STAKE</code></li> <li><code>CUSTOMER_ACQUIRER_NODE_MIN_STAKE</code></li> <li><code>COUNCIL_NODE_MIN_STAKE</code></li> <li><code>MAX_EVIDENCE_AGE</code> (Note that currently in EvidenceParams of ABCI, there’s MaxAge set in the number of blocks, but here we assume time)</li> <li><code>SLASHING_PERIOD_DURATION</code></li> <li><code>JAIL_DURATION</code></li> <li><code>BLOCK_SIGNING_WINDOW</code></li> <li><code>MISSED_BLOCK_THRESHOLD</code></li> <li><code>BYZANTINE_SLASH_RATIO</code></li> <li><code>LIVENESS_SLASH_RATIO</code></li></ul> <p>TODO: TX that can change them?</p> <h3 id="end-commit-block-state-update"><a href="#end-commit-block-state-update" aria-hidden="true" class="header-anchor">#</a> END/COMMIT_BLOCK_STATE_UPDATE</h3> <p>Besides committing all the relevant changes and computing the resulting <code>APP_HASH</code> in BlockCommit; for all changes in Accounts, the implementation needs to signal <code>ValidatorUpdate</code> in EndBlock if the change is relevant to the council node’s staking address:</p> <ul><li>if the <code>bonded</code> amount changes and &gt;= <code>COUNCIL_NODE_MIN_STAKE</code>, then the validator’s power should be set to that amount</li> <li>if the <code>bonded</code> amount changes and &lt; <code>COUNCIL_NODE_MIN_STAKE</code>, then the validator’s power should be set 0</li> <li>if the <code>jailed_until</code> changes to <code>Some(...)</code>, then the validator’s power should be set 0</li> <li>if the <code>jailed_until</code> changes to <code>None</code> (unjailtx or auto?) and <code>bonded</code> amount &gt;= <code>COUNCIL_NODE_MIN_STAKE</code>, then the validator’s power should be set to the <code>bonded</code> amount</li></ul> <h3 id="initchain"><a href="#initchain" aria-hidden="true" class="header-anchor">#</a> InitChain</h3> <p>The initial prototype’s configuration will need to contain the following elements:</p> <ul><li>Above network parameters</li> <li>ERC20 snapshot state / holder mapping <code>initial_holders</code>:
<code>Vec&lt;(address: RedeemAddress, is_contract: bool, amount: Coin)&gt;</code> (or <code>Map&lt;RedeemAddress, (bool, Coin)&gt;</code>)</li> <li>Network long-term incentive address: <code>nlt_address</code></li> <li>Secondary distribution and launch incentive addresses: <code>dist_address1</code>, <code>dist_address2</code></li> <li>initial validators: <code>Vec&lt;CouncilNode&gt;</code></li> <li>bootstrap nodes / initially bonded: <code>Vec&lt;RedeemAddress&gt;</code></li></ul> <p>The validation of the configuration is the following:</p> <ol><li>validate parameters format (e.g. CUSTOMER_ACQUIRER_SHARE + MERCHANT_ACQUIRER_SHARE + COUNCIL_NODE_SHARE = 1.0)</li> <li>check that sum of amounts in <code>initial_holders</code> == MAX_COIN (network constant)</li> <li>check there are no duplicate addresses (if Vec) in <code>initial_holders</code></li> <li>for each <code>council_node</code> in <code>Vec&lt;CouncilNode&gt;</code>: check <code>staking_address</code> is in <code>initial_holders</code> and the amount &gt;= <code>COUNCIL_NODE_MIN_STAKE</code></li> <li>for each <code>address</code> in initially bonded <code>Vec&lt;RedeemAddress&gt;</code>: check <code>address</code> is <code>initial_holders</code> and the amount &gt;= <code>COMMUNITY_NODE_MIN_STAKE</code></li> <li>size(Validators in InitChainRequest) == size(<code>Vec&lt;CouncilNode&gt;</code>) and for every CouncilNode, its <code>consensus_pubkey</code> appears in Validators and power in Validators corresponds to staking address’ amount</li></ol> <p>If valid, the genesis state is then initialized as follows:</p> <ol><li>initialize RewardsPool’s amount with amounts corresponding to: <code>nlt_address</code> + <code>dist_address1</code> + <code>dist_address2</code></li> <li>for every council node, create a <code>CouncilNode</code> structure</li> <li>for every council node’s staking address and every address in initially bonded: create <code>Account</code> where all of the corresponding amount is set as <code>bonded</code></li> <li>for every address in <code>initial_holders</code> except for <code>nlt_address</code>, <code>dist_address1</code>, <code>dist_address2</code>, council nodes’ staking addresses, initially bonded addresses: if <code>is_contract</code> then add the amount to RewardsPool else create <code>Account</code> where the amount is all in <code>unbonded</code> and <code>unbonded_from</code> is set to genesis block’s time (in InitChain)</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/demo-doc-2/getting-started/transaction-privacy.html" class="prev">
          Transaction Privacy
        </a></span> <span class="next"><a href="/demo-doc-2/getting-started/notes-on-production-deployment.html">
          Notes on Production Deployment
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/demo-doc-2/assets/js/app.a0a1c90b.js" defer></script><script src="/demo-doc-2/assets/js/2.f731f746.js" defer></script><script src="/demo-doc-2/assets/js/16.2d6c9435.js" defer></script>
  </body>
</html>
